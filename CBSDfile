# Default PHP version
#PHP_VER=74
PHP_VER=80

# Default Postgresql version
PG_VER="13"
DB_DATABASE=nextcloud
DB_USERNAME=nextcloud
# use CBSD internal function to generate random password, length=30
DB_PASSWORD=$( random_password_gen -l 30 )

DOMAIN=mycloud.example.com

NCUSER="admin"
NCPASS="password"
NCDATAFOLDER="/var/db/nextcloud/data"

WWW_EXPOSE_PORT=8080

quiet=0

jail_nextcloud()
{
	ipv4_addr="DHCP"
	#ip4_addr=$( dhcpd ip4pool=10.100.0.10-200 )
	allow_sysvipc=1
	allow_raw_sockets=1
	host_hostname="${jname}.my.domain"
	ver="native"
	pkg_bootstrap="1"
	nice="0"
	pkglist="security/ca_root_nss shells/bash security/sudo \
	         databases/postgresql${PG_VER}-contrib \
	         databases/postgresql${PG_VER}-server \
	         databases/memcached \
	         www/nginx \
	         lang/php${PHP_VER} \
	         php${PHP_VER}-pecl-APCu \
	         php${PHP_VER}-pecl-memcached \
	         graphics/pecl-imagick \
	         devel/php${PHP_VER}-intl \
	         net/php${PHP_VER}-ldap \
	         devel/php${PHP_VER}-pcntl \
	         archivers/php${PHP_VER}-bz2 \
	         math/php${PHP_VER}-bcmath \
	         math/php${PHP_VER}-gmp \
	         sysutils/php${PHP_VER}-fileinfo \
	         textproc/php${PHP_VER}-ctype \
	         ftp/php${PHP_VER}-curl \
	         textproc/php${PHP_VER}-dom \
	         security/php${PHP_VER}-filter \
	         graphics/php${PHP_VER}-gd \
	         graphics/php${PHP_VER}-exif \
	         converters/php${PHP_VER}-iconv \
	         converters/php${PHP_VER}-mbstring \
	         databases/php${PHP_VER}-mysqli \
	         www/php${PHP_VER}-opcache \
	         security/php${PHP_VER}-openssl \
	         databases/php${PHP_VER}-pdo \
	         databases/php${PHP_VER}-pdo_mysql \
	         databases/php${PHP_VER}-pdo_pgsql \
	         databases/php${PHP_VER}-pdo_sqlite \
	         databases/php${PHP_VER}-pgsql \
	         archivers/php${PHP_VER}-phar \
	         sysutils/php${PHP_VER}-posix \
	         www/php${PHP_VER}-session \
	         textproc/php${PHP_VER}-simplexml \
	         databases/php${PHP_VER}-sqlite3 \
	         devel/php${PHP_VER}-tokenizer \
	         textproc/php${PHP_VER}-xml \
	         textproc/php${PHP_VER}-xmlreader \
	         textproc/php${PHP_VER}-xmlwriter \
	         textproc/php${PHP_VER}-xsl \
	         archivers/php${PHP_VER}-zip \
	         archivers/php${PHP_VER}-zlib"
	         
}

postcreate_nextcloud()
{
	local _ip

	set +o xtrace
	set +o errexit
	# turn off unnecessary services
	sysrc \
		syslogd_flags="-ss -c" \
		sendmail_enable="NO" \
		sendmail_submit_enable="NO" \
		sendmail_outbound_enable="NO" \
		sendmail_msp_queue_enable="NO" \
		nginx_enable="YES" \
		memcached_enable="YES" \
		postgresql_enable="YES" \
		php_fpm_enable="YES"

	# cbsd jexec
	jexec <<EOF
echo "127.0.0.1:5432:${DB_DATABASE}:${DB_USERNAME}:${DB_PASSWORD}" > /root/.pgpass
echo "::1:5432:${DB_DATABASE}:${DB_USERNAME}:${DB_PASSWORD}" >> /root/.pgpass
chmod 0600 /root/.pgpass
EOF
	echo
	${ECHO} "${H3_COLOR}Postgres user password saved in: ${N2_COLOR}${data}/root/.pgpass${N0_COLOR}"
	echo
	set -o xtrace

	# Postgresql setup
	service mode=action postgresql initdb

	# Allow full access to DB
	jexec <<EOF
echo "host    all             all             0.0.0.0/0               trust" >> /var/db/postgres/data${PG_VER}/pg_hba.conf
echo "host    all             all             ::/0                    trust" >> /var/db/postgres/data${PG_VER}/pg_hba.conf
EOF

	# Start postgres
	service mode=action jname=${jname} postgresql start
	sleep 2

	# tests:
	set +o xtrace
	set -o errexit
	tests/10_postgres_port.sh
	set +o errexit
	set -o xtrace

	jexec <<EOF
# create user
psql -d template1 -U postgres -c "CREATE USER ${DB_USERNAME} CREATEDB SUPERUSER;"

# Create the Nextcloud database & grant all privileges on database
psql -d template1 -U postgres -c "CREATE DATABASE ${DB_DATABASE} OWNER ${DB_USERNAME};"

EOF

	# tests
	set +o xtrace
	set -o errexit
	tests/20_postgres_cred.sh
	set +o errexit
	set -o xtrace

	${ECHO} "${H3_COLOR}Installing nextcloud...${N0_COLOR}"
	# execute cmd inside jail
	jexec <<EOF

export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/root/bin
set -o errexit

        make -C /usr/ports/www/nextcloud BATCH=yes PGSQL=yes EXIF=yes IMAGICK=yes INTL=yes PCNTL=yes install clean
	mkdir -p /usr/local/etc/nginx/ssl
	mkdir -p ${NCDATAFOLDER}
	chown -R www:www ${NCDATAFOLDER}
#	echo "${H3_COLOR}Create sessions tmp dir outside nextcloud installation${N0_COLOR}"
#	mkdir -p /tmp/nextcloud-sessions-tmp
#	chmod o-rwx /tmp/nextcloud-sessions-tmp
#	chown -R www:www /tmp/nextcloud-sessions-tmp
EOF

	jscp files/gen-cer ${jname}:/usr/local/etc/nginx/ssl/
	jscp files/php-fpm.conf ${jname}:/usr/local/etc/
	jscp files/php-fpm.d/www.conf ${jname}:/usr/local/etc/php-fpm.d/
	jscp files/php.ini ${jname}:/usr/local/etc/
	jscp files/memcached.json ${jname}:/tmp/
	
	${ECHO} "${H3_COLOR}Nextcloud initialization...${N0_COLOR}"
	jexec <<EOF
	php /usr/local/www/nextcloud/occ maintenance:install --database 'pgsql' --database-name '${DB_DATABASE}' --database-user '${DB_USERNAME}' --database-pass '${DB_PASSWORD}' --admin-user '${NCUSER}' --admin-pass '${NCPASS}' --data-dir='${NCDATAFOLDER}'
	php /usr/local/www/nextcloud/occ config:system:set trusted_domains 1 --value=${DOMAIN}
	php /usr/local/www/nextcloud/occ config:import /tmp/memcached.json
	chown www:www /usr/local/www/nextcloud/config/config.php
EOF
	${ECHO} "${H3_COLOR}Nginx ssl initialization...${N0_COLOR}"
	jexec <<EOF
	cd /usr/local/etc/nginx/ssl
	chmod +x gen-cer
	./gen-cer ${DOMAIN}
	sed -i '' -e 's/cloud.example.com/${DOMAIN}/g' /usr/local/etc/nginx/nginx.conf
EOF

	expose mode=add in=${WWW_EXPOSE_PORT} out=443
	service mode=action php-fpm start || true
	service mode=action memcached start || true
	service mode=action nginx start || true

	# tests
	set +o xtrace
	set -o errexit
	tests/50_nginx_process.sh
	set +o errexit
	set -o xtrace
}
